{% extends "base.html" %}

{% block content %}

{% if not current_filter %}
<h3 class="ui header">
    <div class="content">
        Snowball
        <div class="sub header">{{ stocks|count }}종목</div>
    </div>
</h3>
<form class="ui form" action="{{ url_for('add_stock') }}" method="post">
    <div class="fields">
        <div class="eight wide field">
            <input type="text" name="code" placeholder="종목코드를 입력하세요">
        </div>
        <div class="eight wide field">
            <button class="ui button" type="submit">추가</button>
        </div>
    </div>
</form>
{% endif %}
{% if current_filter %}
<div class="ui segment">
    <form class="ui form" action="{{ url_for('stocks_save_filter', filter_id=current_filter._id) }}" method="POST">
        <input type="hidden" name="current_filter_id" value="{{ current_filter._id }}">
        <div class="fields">
            <div class="six wide field">
                <label>필터명</label>
                <input type="text" placeholder="필터명" name="filter_name" value="{{ current_filter.name }}">
            </div>
            <div class="four wide field">
                <label>&nbsp;</label>
                <button class="ui button" type="submit">필터명 변경</button>
                <a class="ui button red" href="{{ url_for('stocks_remove_filter', filter_id=current_filter._id) }}">필터 삭제</a>
            </div>
        </div>
    </form>
    <div class="ui list">
        {% for filter_option in current_filter.options %}
        <span class="ui label black">
            {{ filter_option.title }} 
            {{ filter_option.value }}
            <b>{% if filter_option.morethan %}
                이상
            {% else %}
                이하
            {% endif %}
            </b> | 
            <a href="{{ url_for('stocks_remove_filter_option', filter_id=current_filter._id, filter_option_id=filter_option._id) }}">제거</a>
        </span>
        {% endfor %}
    </div>
    <form class="ui form" action="{{ url_for('stocks_add_filter_option', filter_id=current_filter._id) }}" method="POST">
        <div class="four fields">
            <div class="field">
                <select class="ui fluid dropdown" name="filter_option_key">
                    {% for filter_option in available_filter_options %}
                    <option value="{{ filter_option.key }}">{{ filter_option.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="field">
                <input type="number" name="filter_option_value" placeholder="값">
            </div>
            <div class="field">
                <select class="ui fluid dropdown" name="filter_option_morethan">
                    <option value="morethan">이상</option>
                    <option value="lessthan">이하</option>
                </select>
            </div>
            <div class="field">
                <button class="ui button" type="submit">필터링 옵션 추가</button>
            </div>
        </div>
        <div>{{ stocks|count }}종목</div>
    </form>
</div>
<br>
{% endif %}
<div class="ui grid">
    <div class="sixteen wide column">
        <table class="ui very basic compact table">
            <thead>
            <tr>
                <th>종목코드</th>
                <th>
                    <a href="{{ url_for('stocks', status=status) }}?order_by=title&ordering={% if ordering == 'asc' %}desc{% else %}asc{% endif %}">종목명</a>
                    {% if order_by == 'title' %}{% if ordering == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                </th>
                <th>
                    <a href="{{ url_for('stocks', status=status) }}?order_by=current_price&ordering={% if ordering == 'asc' %}desc{% else %}asc{% endif %}">현재가</a>
                    {% if order_by == 'current_price' %}{% if ordering == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                </th>
                <th>
                    변동
                </th>
                <th>
                    <a href="{{ url_for('stocks', status=status) }}?order_by=per&ordering={% if ordering == 'asc' %}desc{% else %}asc{% endif %}">PER</a>
                    {% if order_by == 'per' %}{% if ordering == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                </th>
                <th>
                    <a href="{{ url_for('stocks', status=status) }}?order_by=pbr&ordering={% if ordering == 'asc' %}desc{% else %}asc{% endif %}">PBR</a>
                    {% if order_by == 'pbr' %}{% if ordering == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                </th>
                <th>
                    <a href="{{ url_for('stocks', status=status) }}?order_by=future_roe&ordering={% if ordering == 'asc' %}desc{% else %}asc{% endif %}">fROE</a>
                    {% if order_by == 'future_roe' %}{% if ordering == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                </th>
                <th>
                    <a href="{{ url_for('stocks', status=status) }}?order_by=expected_rate&ordering={% if ordering == 'asc' %}desc{% else %}asc{% endif %}">기대</a>
                    {% if order_by == 'expected_rate' %}{% if ordering == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                </th>
                <th>
                    <a href="{{ url_for('stocks', status=status) }}?order_by=expected_rate_by_current_pbr&ordering={% if ordering == 'asc' %}desc{% else %}asc{% endif %}">현P기</a>
                    {% if order_by == 'expected_rate_by_current_pbr' %}{% if ordering == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                </th>
                <th>
                    <a href="{{ url_for('stocks', status=status) }}?order_by=expected_rate_by_mid_pbr&ordering={% if ordering == 'asc' %}desc{% else %}asc{% endif %}">중P기</a>
                    {% if order_by == 'expected_rate_by_mid_pbr' %}{% if ordering == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                </th>
                <th>
                    <a href="{{ url_for('stocks', status=status) }}?order_by=expected_rate_by_low_pbr&ordering={% if ordering == 'asc' %}desc{% else %}asc{% endif %}">저P기</a>
                    {% if order_by == 'expected_rate_by_low_pbr' %}{% if ordering == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                </th>
                <th>
                    FScore
                </th>
                <th>
                </th>
            </tr>
            </thead>
            <tbody>
                {% for stock in stocks %}
                <tr>
                    <td>{{ stock.code }}</td>
                    <td><a href="{{ url_for('stock', code=stock.code) }}">{{ stock.title }}</a></td>
                    <td class="{{ stock.price_color }}">{{ stock.price_arrow }} {{ stock.current_price|round|int }}</td>
                    <td class="{{ stock.price_color }}">{{ stock.price_sign }}{{ '%.2f'|format(stock.rate_diff) }}%</td>
                    <td>{{ stock.per }}</td>
                    <td>{{ stock.pbr }}</td>
                    <td>
                         <div class="ui label">
                             {{ '%.2f'|format(stock.future_roe or 0) }}
                             {% if stock.calculated_roe_count < 4 %}
                             &nbsp; ({{stock.calculated_roe_count}}/4)
                             {% endif %}
                         </div>
                        {% if 'adjusted_future_roe' in stock and stock['adjusted_future_roe']|float > 0 %}
                            <div class="ui label yellow">{{ '%.2f'|format(stock.adjusted_future_roe or 0) }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {% if stock.calculable %}
                            {{ '%.2f'|format(stock.expected_rate or 0) }}
                        {% endif %}
                    </td>
                    <td>
                        {% if stock.calculable %}
                            {% if stock.low_pbr > stock.pbr %}<span class="ui label black">{% endif %}
                            {{ '%.2f'|format(stock.expected_rate_by_current_pbr or 0) }}
                            {% if stock.low_pbr > stock.pbr %}</span>{% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if stock.calculable %}
                            {{ '%.2f'|format(stock.expected_rate_by_mid_pbr or 0) }}
                        {% endif %}
                    </td>
                    <td>
                        {% if stock.calculable %}
                            {% if stock.calculable_pbr_count < 4 %}
                            <span class="ui label gray">
                            {% endif %}
                            {{ '%.2f'|format(stock.expected_rate_by_low_pbr or 0) }}
                            {% if stock.calculable_pbr_count < 4 %}
                            </span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>{{ stock.latest_fscore }}</td>
                    <td>
                        {% if stock.owned %}
                            <i class="icon heart red"></i>
                        {% elif stock.starred %}
                            <i class="icon star yellow"></i>
                        {% endif %}
                        {% if stock.has_note %}
                            <i class="icon file alternate"></i>
                        {% endif %}
                        {% if stock.doubtful %}
                        <i class="icon flag red"></i>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}